<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Subway Seat Rush Simulator</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            color: white;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            touch-action: none; 
            user-select: none;
        }

        #gameContainer {
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 960px;
            max-width: 100%;
            aspect-ratio: 16/9;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #ecf0f1;
            border-radius: 4px;
            cursor: pointer; 
            outline: none;
            touch-action: none;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 20;
        }
        .hidden { display: none !important; }

        h1 { font-size: 2.5rem; margin-bottom: 10px; color: #f1c40f; text-transform: uppercase; letter-spacing: 2px; }
        h2 { margin: 10px 0; font-size: 1.5rem; color: #bdc3c7; }
        p { font-size: 1.2rem; margin-bottom: 20px; color: #bdc3c7; max-width: 80%; line-height: 1.5; }
        
        .btn-group { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; justify-content: center; }

        .btn {
            background: #3498db;
            border: none;
            padding: 12px 30px;
            color: white;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            pointer-events: auto;
            transition: transform 0.1s, background 0.2s;
            font-family: inherit;
        }
        .btn:hover { transform: scale(1.05); }
        .btn:active { transform: scale(0.95); }

        .btn-easy { background: #2ecc71; }
        .btn-med { background: #f39c12; }
        .btn-hard { background: #e74c3c; }
        .btn-custom { background: #9b59b6; border: 2px solid #8e44ad; }
        .btn-back { background: transparent; border: 2px solid #7f8c8d; color: #bdc3c7; }
        .btn-layout { background: #34495e; border: 1px solid #7f8c8d; font-size: 0.9rem; padding: 8px 15px; }
        .btn.selected { box-shadow: 0 0 0 4px white; transform: scale(1.1); }

        /* Custom Menu Styles */
        .scroll-area {
            width: 90%;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
            scrollbar-width: thin;
            scrollbar-color: #7f8c8d transparent;
        }
        .station-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; justify-content: center; }
        .station-row input { padding: 8px; border-radius: 4px; border: none; width: 130px; background: #ecf0f1; }
        .btn-icon { padding: 5px 12px; border-radius: 5px; cursor:pointer; font-weight:bold; border:none; color:white; }
        .btn-remove { background: #e74c3c; }

        .color-picker-row {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            padding: 5px 20px;
            border-radius: 10px;
        }
        .color-group { display: flex; flex-direction: column; align-items: center; }
        .color-group label { font-size: 0.8rem; color: #bdc3c7; margin-bottom: 2px; }
        input[type="color"] { border: none; width: 40px; height: 25px; cursor: pointer; background: none; }

        /* Save Manager Styles */
        .save-manager {
            width: 90%;
            background: rgba(52, 73, 94, 0.8);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #7f8c8d;
        }
        .save-input-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .save-input-row input { padding: 8px; border-radius: 4px; border:none; width: 60%; }
        .save-list-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2); padding: 5px 10px; margin-bottom: 5px; border-radius: 4px;
        }
        .save-name { color: #f1c40f; font-weight: bold; font-size: 0.9rem; cursor: pointer; flex-grow: 1; text-align: left; }
        .save-name:hover { text-decoration: underline; }

        .top-controls { position: absolute; top: 20px; right: 20px; z-index: 30; display: flex; gap: 10px; }
        .control-btn {
            background: rgba(255,255,255,0.2); border: 1px solid white; color: white;
            padding: 5px 15px; cursor: pointer; border-radius: 20px; font-weight: bold;
        }

        /* HUD - Full Width Integration */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 0; box-sizing: border-box; z-index: 10; 
            display: flex; flex-direction: column; justify-content: space-between;
            pointer-events: none; 
        }
        
        .hud-top {
            width: 100%;
            background: rgba(44, 62, 80, 0.95);
            border-bottom: 4px solid #34495e;
            padding: 10px 0;
            display: flex; justify-content: center;
        }

        .hud-bottom {
            width: 100%;
            background: rgba(44, 62, 80, 0.95);
            border-top: 4px solid #34495e;
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: center;
        }

        .hud-interactive { pointer-events: auto; }
        .hud-label { font-size: 0.8rem; color: #bdc3c7; }
        .hud-value { font-size: 1.2rem; font-weight: bold; }
        
        #energyBarContainer { width: 150px; height: 15px; background: #555; border-radius: 10px; overflow: hidden; border: 2px solid #fff; }
        #energyFill { width: 100%; height: 100%; background: #2ecc71; transition: width 0.2s; }

        #routeContainer { width: 90%; height: 30px; display: flex; align-items: center; position: relative; margin-bottom: 5px; }
        #routeLine { width: 100%; height: 4px; background: #7f8c8d; position: absolute; top: 13px; z-index: 1; }
        .station-dot { width: 12px; height: 12px; background: #bdc3c7; border-radius: 50%; position: absolute; top: 9px; z-index: 2; }
        #trainIcon { position: absolute; top: 0px; left: 0%; font-size: 20px; z-index: 3; transition: left 1s linear; }
        .station-label { position: absolute; top: 25px; font-size: 10px; color: #95a5a6; transform: translateX(-50%); white-space: nowrap; text-shadow: 1px 1px 2px #000; }

        .hud-btn { border: none; color: white; font-weight: bold; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-left: 5px; }
        #pauseBtn { background: #e67e22; }
        #restartBtn { background: #c0392b; }
        
        #notification {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(231, 76, 60, 0.9); color: white; padding: 10px 20px;
            border-radius: 5px; font-weight: bold; opacity: 0; transition: opacity 0.5s;
            pointer-events: none; z-index: 15; white-space: nowrap;
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <div class="top-controls">
        <button class="control-btn" onclick="toggleLanguage()">üåê EN/‰∏≠</button>
    </div>
    <canvas id="gameCanvas" width="960" height="540"></canvas>
    <div id="notification"></div>

    <div id="hud" class="hidden">
        <div class="hud-top">
            <div id="routeContainer">
                <div id="routeLine"></div>
                <div id="trainIcon">üöÜ</div>
            </div>
        </div>
        <div class="hud-bottom">
            <div style="display:flex; flex-direction:column;">
                <span class="hud-label" data-i18n="energy">ENERGY</span>
                <div id="energyBarContainer"><div id="energyFill"></div></div>
            </div>
            <div style="display:flex; gap:5px; align-items:center;" class="hud-interactive">
                <div style="margin-right: 10px; text-align: right;">
                    <span class="hud-label" style="display:block;" data-i18n="time">TIME</span>
                    <span class="hud-value" id="timer">60s</span>
                </div>
                <button id="pauseBtn" class="hud-btn" onclick="game.togglePause()">II</button>
                <button id="restartBtn" class="hud-btn" onclick="game.goToMenu()">‚Üª</button>
            </div>
        </div>
    </div>

    <div id="startScreen" class="overlay">
        <h1 data-i18n="title">Subway Seat Rush</h1>
        
        <div class="btn-group" style="margin: 5px 0;">
            <span style="display:flex; align-items:center; font-size:0.9rem; color:#bdc3c7; margin-right:10px;" data-i18n="layout">Layout:</span>
            <button id="l-auto" class="btn btn-layout selected" onclick="game.setLayout('auto')">Auto</button>
            <button id="l-land" class="btn btn-layout" onclick="game.setLayout('landscape')">‚Üî</button>
            <button id="l-port" class="btn btn-layout" onclick="game.setLayout('portrait')">‚Üï</button>
        </div>

        <p data-i18n="selectDiff" style="margin-top:15px;">Select Difficulty</p>
        <div class="btn-group">
            <button class="btn btn-easy" onclick="game.start('easy')" data-i18n="easy">EASY</button>
            <button class="btn btn-med" onclick="game.start('medium')" data-i18n="medium">MEDIUM</button>
            <button class="btn btn-hard" onclick="game.start('hard')" data-i18n="hard">HARD</button>
        </div>
        <div class="btn-group">
            <button class="btn btn-custom" onclick="customMenu.open()" data-i18n="custom">CUSTOM</button>
        </div>
    </div>

    <div id="customScreen" class="overlay hidden">
        <h2 data-i18n="customTitle">Customize Trip</h2>
        <div class="save-manager">
            <div class="save-input-row">
                <input type="text" id="saveNameInput" placeholder="Route Name...">
                <button class="btn-icon" style="background:#3498db" onclick="customMenu.saveProfile()">üíæ <span data-i18n="btnSave">Save</span></button>
            </div>
            <div style="font-size:0.8rem; color:#bdc3c7; text-align:left; margin-bottom:5px;" data-i18n="savedFiles">Saved Files:</div>
            <div class="scroll-area" id="saveList" style="max-height:80px; margin:0;"></div>
        </div>
        <div style="display:flex; gap:10px; width:90%; justify-content:center;">
            <div style="flex:1;">
                <div class="btn-group" style="margin: 5px 0; justify-content:flex-start; gap:5px;">
                    <button id="c-easy" class="btn btn-layout" onclick="customMenu.setDiff('easy')" data-i18n="easy">EASY</button>
                    <button id="c-med" class="btn btn-layout selected" onclick="customMenu.setDiff('medium')" data-i18n="medium">MEDIUM</button>
                    <button id="c-hard" class="btn btn-layout" onclick="customMenu.setDiff('hard')" data-i18n="hard">HARD</button>
                </div>
                <div class="color-picker-row">
                    <div class="color-group"><label data-i18n="floorColor">Floor</label><input type="color" id="picker-floor" value="#ecf0f1" onchange="customMenu.colors.floor = this.value"></div>
                    <div class="color-group"><label data-i18n="seatColor">Seat</label><input type="color" id="picker-seat" value="#bdc3c7" onchange="customMenu.colors.seat = this.value"></div>
                </div>
            </div>
            <div style="flex:1;">
                <div class="scroll-area" id="stationList"></div>
                <button class="btn btn-icon" style="background:#2ecc71; width:100%; margin-top:5px;" onclick="customMenu.addStation()">+ <span data-i18n="addStop">Add</span></button>
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-back" onclick="customMenu.close()" data-i18n="back">BACK</button>
            <button class="btn" style="background:#f1c40f; color:#2c3e50;" onclick="customMenu.start()" data-i18n="start">START</button>
        </div>
    </div>

    <div id="pauseScreen" class="overlay hidden">
        <h1 data-i18n="paused">PAUSED</h1>
        <button class="btn" onclick="game.togglePause()" data-i18n="resume">RESUME</button>
        <button class="btn" style="background:#c0392b; margin-top:10px;" onclick="game.goToMenu()" data-i18n="menu">MENU</button>
    </div>
    <div id="gameOverScreen" class="overlay hidden">
        <h1 id="resultTitle">TRIP COMPLETE</h1>
        <div class="stars" id="resultStars" style="font-size:3rem; color:#f1c40f;">‚≠ê‚≠ê‚≠ê</div>
        <p id="resultMessage">Energy remaining: 85</p>
        <button class="btn" onclick="game.goToMenu()" data-i18n="backMenu">BACK TO MENU</button>
    </div>
</div>

<script>
/** LOCALIZATION */
const TEXT = {
    en: {
        title: "Subway Seat Rush", selectDiff: "Select Difficulty",
        easy: "EASY", medium: "MEDIUM", hard: "HARD", custom: "CUSTOM", energy: "ENERGY", time: "TIME", paused: "PAUSED", resume: "RESUME",
        menu: "MENU", backMenu: "BACK TO MENU", station: "STATION", arrival: "ARRIVAL", exhausted: "EXHAUSTED", safe: "ARRIVED SAFELY",
        collapsed: "You collapsed.", finalEnergy: "Final Energy", sit: "SIT", walk: "WALK", st: "St", end: "End",
        customTitle: "Route Editor", lblEN: "Name (EN)", lblZH: "Name (ZH)", addStop: "Add Stop", back: "BACK", start: "START",
        floorColor: "Floor Color", seatColor: "Seat Frame", layout: "Layout:", btnSave: "Save", savedFiles: "Saved Routes:", load: "Load"
    },
    zh: {
        title: "Âú∞ÈìÅÊä¢Â∫ßÂ§ß‰ΩúÊàò", selectDiff: "ÈÄâÊã©ÈöæÂ∫¶",
        easy: "ÁÆÄÂçï", medium: "ÊôÆÈÄö", hard: "Âõ∞Èöæ", custom: "Ëá™ÂÆö‰πâ", energy: "‰ΩìÂäõ", time: "Ââ©‰ΩôÊó∂Èó¥", paused: "ÊöÇÂÅú", resume: "ÁªßÁª≠",
        menu: "‰∏ªËèúÂçï", backMenu: "ËøîÂõû‰∏ªËèúÂçï", station: "Á´ôÁÇπ", arrival: "Âç≥Â∞ÜÂà∞Ëææ", exhausted: "‰ΩìÂäõËÄóÂ∞Ω", safe: "ÂÆâÂÖ®ÊäµËææ",
        collapsed: "‰Ω†ÂÄí‰∏ã‰∫Ü„ÄÇ", finalEnergy: "Ââ©‰Ωô‰ΩìÂäõ", sit: "Âùê‰∏ã", walk: "Ë°åËµ∞", st: "Á´ô", end: "ÁªàÁÇπ",
        customTitle: "Ë∑ØÁ∫øÁºñËæëÂô®", lblEN: "Á´ôÂêç (Ëã±Êñá)", lblZH: "Á´ôÂêç (‰∏≠Êñá)", addStop: "Ê∑ªÂä†Á´ôÁÇπ", back: "ËøîÂõû", start: "ÂºÄÂßãË°åÁ®ã",
        floorColor: "Âú∞ÊùøÈ¢úËâ≤", seatColor: "Â∫ß‰ΩçËæπÊ°Ü", layout: "Â∏ÉÂ±Ä:", btnSave: "‰øùÂ≠ò", savedFiles: "Â≠òÊ°£ÂàóË°®:", load: "ËØªÂèñ"
    }
};

let CUR_LANG = 'en';
const CONFIG = {
    PLAYER_SPEED: 400, NPC_EXIT_SPEED: 100, ENERGY_MAX: 100, ENERGY_DRAIN: 2, ENERGY_REGAIN: 1, 
    COLORS: { PLAYER: '#3498db', NPC: '#7f8c8d', SEAT_VACANT_A: '#2ecc71', SEAT_VACANT_B: '#00ff00', DOOR_OPEN: '#e67e22', TARGET_RING: '#e74c3c' },
    FLOOR: '#ecf0f1', SEAT_FRAME: '#bdc3c7'
};

const LEVELS = {
    easy:   { rushSpeed: 120, standingCount: 3 },
    medium: { rushSpeed: 160, standingCount: 15 },
    hard:   { rushSpeed: 260, standingCount: 50 } 
};

// HELPER
const rnd = (min, max) => Math.random() * (max - min) + min;
const checkCircleRect = (c, r) => {
    let tx = Math.max(r.x, Math.min(c.x, r.x + r.w));
    let ty = Math.max(r.y, Math.min(c.y, r.y + r.h));
    return ((c.x - tx) ** 2 + (c.y - ty) ** 2) <= c.r ** 2;
};
const getDist = (a, b) => Math.hypot(a.x - b.x, a.y - b.y);

function toggleLanguage() {
    CUR_LANG = (CUR_LANG === 'en') ? 'zh' : 'en';
    updateText();
}

function updateText() {
    const t = TEXT[CUR_LANG];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(t[key]) el.innerText = t[key];
    });
    if(game.isRunning) game.rebuildRouteUI();
    if(!document.getElementById('customScreen').classList.contains('hidden')) customMenu.renderInputs();
}

// --- CUSTOM MENU ---
const customMenu = {
    stops: [], diff: 'medium', colors: { floor: '#ecf0f1', seat: '#bdc3c7' }, saves: [],
    init() {
        const storedSaves = localStorage.getItem('subway_saves');
        if(storedSaves) { try { this.saves = JSON.parse(storedSaves); } catch(e) {} }
        this.resetToDefault();
    },
    resetToDefault() {
        this.stops = [{en: "Civic Ctr", zh: "Â∏ÇÊ∞ë‰∏≠ÂøÉ"}, {en: "Union Sq", zh: "ËÅîÂêàÂπøÂú∫"}, {en: "Chinatown", zh: "Âîê‰∫∫Ë°ó"}, {en: "Terminal", zh: "ÁªàÁÇπÁ´ô"}];
        this.diff = 'medium'; this.colors = { floor: '#ecf0f1', seat: '#bdc3c7' };
    },
    open() {
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('customScreen').classList.remove('hidden');
        this.refreshUI();
    },
    close() {
        document.getElementById('customScreen').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
    },
    refreshUI() {
        this.setDiff(this.diff);
        document.getElementById('picker-floor').value = this.colors.floor;
        document.getElementById('picker-seat').value = this.colors.seat;
        this.renderInputs(); this.renderSaves();
    },
    setDiff(d) {
        this.diff = d;
        ['c-easy', 'c-med', 'c-hard'].forEach(id => document.getElementById(id).classList.remove('selected'));
        if(d==='easy') document.getElementById('c-easy').classList.add('selected');
        if(d==='medium') document.getElementById('c-med').classList.add('selected');
        if(d==='hard') document.getElementById('c-hard').classList.add('selected');
    },
    saveProfile() {
        const name = document.getElementById('saveNameInput').value.trim() || ("Route " + (this.saves.length + 1));
        this.saves.push({ name: name, stops: JSON.parse(JSON.stringify(this.stops)), diff: this.diff, colors: {...this.colors} });
        localStorage.setItem('subway_saves', JSON.stringify(this.saves));
        this.renderSaves();
    },
    loadProfile(index) {
        const s = this.saves[index];
        this.stops = JSON.parse(JSON.stringify(s.stops)); this.diff = s.diff; this.colors = {...s.colors};
        this.refreshUI();
    },
    deleteProfile(index) {
        this.saves.splice(index, 1);
        localStorage.setItem('subway_saves', JSON.stringify(this.saves));
        this.renderSaves();
    },
    renderSaves() {
        const list = document.getElementById('saveList'); list.innerHTML = '';
        this.saves.forEach((s, i) => {
            const row = document.createElement('div'); row.className = 'save-list-row';
            row.innerHTML = `<div class="save-name" onclick="customMenu.loadProfile(${i})">${s.name} (${s.stops.length} Stops)</div><button class="btn-icon btn-remove" onclick="customMenu.deleteProfile(${i})">X</button>`;
            list.appendChild(row);
        });
    },
    renderInputs() {
        const list = document.getElementById('stationList'); list.innerHTML = '';
        this.stops.forEach((stop, i) => {
            const row = document.createElement('div'); row.className = 'station-row';
            row.innerHTML = `<span style="color:#f1c40f;font-weight:bold;font-size:0.8rem">${i+1}</span><input type="text" value="${stop.en}" onchange="customMenu.update(${i},'en',this.value)"><input type="text" value="${stop.zh}" onchange="customMenu.update(${i},'zh',this.value)"><button class="btn btn-icon btn-remove" onclick="customMenu.remove(${i})" ${this.stops.length<=2?'disabled':''}>X</button>`;
            list.appendChild(row);
        });
    },
    update(i, l, v) { this.stops[i][l] = v; },
    addStation() { if(this.stops.length < 10) { this.stops.push({en: "Stop", zh: "Á´ô"}); this.renderInputs(); } },
    remove(i) { if(this.stops.length > 2) { this.stops.splice(i, 1); this.renderInputs(); } },
    start() {
        CONFIG.FLOOR = this.colors.floor; CONFIG.SEAT_FRAME = this.colors.seat;
        const dur = this.stops.length * 15;
        const gs = this.stops.map((s, idx) => ({ t: dur - ((idx+1)*15), name_en: s.en, name_zh: s.zh }));
        gs[gs.length-1].t = 0.5;
        document.getElementById('customScreen').classList.add('hidden');
        game.start(this.diff, gs, dur);
    }
};

// ENTITIES
class Seat {
    constructor(id, x, y) { this.id = id; this.x = x; this.y = y; this.w = 50; this.h = 50; this.occupant = null; this.isVacant = false; this.flashTimer = 0; }
    draw(ctx) {
        ctx.fillStyle = this.isVacant ? ((Math.sin(this.flashTimer += 0.2) > 0) ? CONFIG.COLORS.SEAT_VACANT_B : CONFIG.COLORS.SEAT_VACANT_A) : CONFIG.SEAT_FRAME;
        ctx.fillRect(this.x, this.y, this.w, this.h);
        ctx.fillStyle = 'rgba(0,0,0,0.15)'; ctx.fillRect(this.x+4, this.y+4, this.w-8, this.h-8);
    }
}

class Actor {
    constructor(x, y, isPlayer) { this.x = x; this.y = y; this.r = 14; this.isPlayer = isPlayer; this.seat = null; this.targetSeat = null; this.targetDoor = null; this.isExiting = false; this.isDead = false; }
    sit(seat) { this.seat = seat; seat.occupant = this; seat.isVacant = false; this.x = seat.x + seat.w/2; this.y = seat.y + seat.h/2; this.targetSeat = null; }
    standUp() { if (this.seat) { this.seat.occupant = null; this.seat = null; } }
    exitTrain(tx, ty) {
        this.standUp(); this.isExiting = true; this.targetDoor = {x: tx, y: ty};
        const dx = tx - this.x, dy = ty - this.y; const len = Math.hypot(dx, dy);
        this.x += (dx/len) * 20; this.y += (dy/len) * 20;
    }
    draw(ctx) {
        if (this.isDead && !this.isPlayer) return;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
        ctx.fillStyle = this.isPlayer ? CONFIG.COLORS.PLAYER : CONFIG.COLORS.NPC;
        ctx.fill(); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
        if (this.isPlayer) {
            ctx.fillStyle = "white"; ctx.font = "bold 10px sans-serif"; ctx.textAlign = "center";
            ctx.fillText(this.seat ? TEXT[CUR_LANG].sit : TEXT[CUR_LANG].walk, this.x, this.y - 20);
        }
        if (this.seat) { ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.r-4, 0, Math.PI*2); ctx.fill(); }
    }
}

// GAME ENGINE
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.keys = {}; this.pointer = {x:0, y:0, isDown:false};
        this.isRunning = false; this.layoutMode = 'auto'; 
        window.addEventListener('resize', () => this.resize());
        setTimeout(() => this.resize(), 100);
        this.setupInputs();
        customMenu.init();
    }

    setLayout(mode) {
        this.layoutMode = mode;
        ['l-auto', 'l-land', 'l-port'].forEach(id => document.getElementById(id).classList.remove('selected'));
        if(mode === 'auto') document.getElementById('l-auto').classList.add('selected');
        if(mode === 'landscape') document.getElementById('l-land').classList.add('selected');
        if(mode === 'portrait') document.getElementById('l-port').classList.add('selected');
        this.resize();
    }

    resize() {
        const cw = document.body.clientWidth;
        const ch = document.body.clientHeight;
        if (this.layoutMode === 'landscape') this.isPortrait = false;
        else if (this.layoutMode === 'portrait') this.isPortrait = true;
        else this.isPortrait = ch > cw; 

        if (this.isPortrait) { this.width = 540; this.height = 960; } 
        else { this.width = 960; this.height = 540; }
        
        this.canvas.width = this.width;
        this.canvas.height = this.height;
        document.getElementById('gameContainer').style.width = this.width + 'px';
        document.getElementById('gameContainer').style.maxWidth = '100vw';
        document.getElementById('gameContainer').style.maxHeight = '100vh';
        document.getElementById('gameContainer').style.aspectRatio = this.width + '/' + this.height;

        const scale = Math.min(cw / this.width, ch / this.height);
        this.canvas.style.width = '100%';
        this.canvas.style.height = '100%';
        this.scaleRatio = scale;

        if(this.isRunning) this.buildLevel(); 
    }

    setupInputs() {
        window.addEventListener('keydown', e => { if(e.key.toLowerCase()==='p') this.togglePause(); this.keys[e.key]=true; });
        window.addEventListener('keyup', e => this.keys[e.key]=false);
        const updatePointer = (e) => {
            const rect = this.canvas.getBoundingClientRect();
            this.pointer.x = (e.clientX - rect.left) * (this.width / rect.width);
            this.pointer.y = (e.clientY - rect.top) * (this.height / rect.height);
        };
        this.canvas.addEventListener('pointerdown', e => { this.canvas.setPointerCapture(e.pointerId); updatePointer(e); this.pointer.isDown=true; });
        this.canvas.addEventListener('pointermove', e => updatePointer(e));
        this.canvas.addEventListener('pointerup', e => { this.canvas.releasePointerCapture(e.pointerId); this.pointer.isDown=false; });
    }

    goToMenu() {
        this.isRunning = false;
        document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
    }

    start(difficulty, customStations = null, customDuration = 60) {
        this.currentLevel = LEVELS[difficulty];
        if(!customStations) { CONFIG.FLOOR = '#ecf0f1'; CONFIG.SEAT_FRAME = '#bdc3c7'; }
        this.stations = customStations || [
            { t: 45, name_en: "Civic Center", name_zh: "Â∏ÇÊ∞ë‰∏≠ÂøÉ" },
            { t: 30, name_en: "Union Sq", name_zh: "ËÅîÂêàÂπøÂú∫" },
            { t: 15, name_en: "Chinatown", name_zh: "Âîê‰∫∫Ë°ó" },
            { t: 0.5, name_en: "Terminal", name_zh: "ÁªàÁÇπÁ´ô" }
        ];
        this.totalDuration = customDuration;
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        this.isPaused = false; this.resize();
        this.keys = {}; this.pointer.isDown = false;
        this.seats = []; this.npcs = [];
        this.player = new Actor(this.width/2, this.height/2, true);
        this.energy = CONFIG.ENERGY_MAX; this.timeLeft = this.totalDuration;
        this.nextStationIndex = 0; this.isRunning = true; this.lastTime = performance.now();
        this.doorsOpen = false;
        this.buildLevel(); this.spawnInitialNPCs(); this.rebuildRouteUI();
        requestAnimationFrame(t => this.loop(t));
    }

    buildLevel() {
        this.seats = [];
        const w = 50, h = 50, sp = 10;
        
        // Dynamic Seat Centering Calculation
        if (!this.isPortrait) {
            const startX = 60; const midGap = 160;
            // Landscape: Rows adjusted to be vertically centered between Top/Bottom Bars
            const rowY_Top = 110; 
            const rowY_Bot = 400; // Lifted from bottom to avoid overlap

            // Calculate Center X for symmetrical layout
            const blockWidth = (6 * (w + sp)); // ~360
            const totalContent = (blockWidth * 2) + midGap - sp; // 860ish
            const marginX = (this.width - totalContent) / 2;

            for(let i=0; i<24; i++) {
                let r = Math.floor(i / 12); let c = i % 12;
                let x = marginX + c * (w + sp);
                if (c >= 6) x += midGap;
                let y = (r === 0) ? rowY_Top : rowY_Bot;
                this.seats.push(new Seat(i, x, y));
            }
        } else {
            // Portrait: Vertical centering logic
            const midGap = 120; // Reduced gap for tight vertical fit
            const spV = 8; // Reduced vertical spacing
            const colX_Left = 40; 
            const colX_Right = this.width - 40 - w;

            // Calculate vertical center start point
            // Height of one block = 6 * (50+8) = 348
            // Total height = 348 * 2 + Gap = 696 + 120 = 816
            // Canvas Height = 960. Margin = (960 - 816) / 2 = 72.
            const startY = 85; 

            for(let i=0; i<24; i++) {
                let side = Math.floor(i / 12); let row = i % 12;
                let y = startY + row * (h + spV);
                if (row >= 6) y += midGap;
                let x = (side === 0) ? colX_Left : colX_Right;
                this.seats.push(new Seat(i, x, y));
            }
        }
        if(this.player && !this.player.seat) { 
            this.player.x = this.width/2; this.player.y = this.height/2; 
        }
    }

    spawnInitialNPCs() {
        this.npcs = [];
        let all = [...this.seats];
        for (let i = all.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [all[i], all[j]] = [all[j], all[i]]; }
        for(let i=0; i<22; i++) { const npc = new Actor(0,0,false); this.npcs.push(npc); npc.sit(all[i]); }
        const area = this.isPortrait ? {minX:120, maxX:400, minY:100, maxY:850} : {minX:50, maxX:900, minY:170, maxY:380};
        for(let i=0; i<this.currentLevel.standingCount; i++) { this.npcs.push(new Actor(rnd(area.minX, area.maxX), rnd(area.minY, area.maxY), false)); }
        for(let i=22; i<24; i++) { all[i].isVacant = true; this.assignRushers(all[i]); }
    }

    rebuildRouteUI() {
        const c = document.getElementById('routeContainer');
        c.innerHTML = '<div id="routeLine"></div><div id="trainIcon">üöÜ</div>';
        const count = this.stations.length;
        this.stations.forEach((s, i) => {
            const pct = (i / (count - 1)) * 90 + 5; 
            const dot = document.createElement('div'); dot.className = 'station-dot'; dot.style.left = pct + '%';
            c.appendChild(dot);
            const lbl = document.createElement('div'); lbl.className = 'station-label';
            lbl.innerText = (CUR_LANG === 'zh') ? s.name_zh : s.name_en;
            lbl.style.left = pct + '%';
            c.appendChild(lbl);
        });
    }

    togglePause() {
        if(!this.isRunning) return;
        this.isPaused = !this.isPaused;
        document.getElementById('pauseScreen').classList.toggle('hidden', !this.isPaused);
        if(!this.isPaused) this.lastTime = performance.now();
    }

    resolveCollision(a, b) {
        const dx = b.x - a.x, dy = b.y - a.y;
        const d = Math.hypot(dx, dy), minD = a.r + b.r;
        if (d < minD && d > 0.001) {
            const overlap = minD - d;
            const mx = (dx/d) * overlap/2, my = (dy/d) * overlap/2;
            a.x -= mx; a.y -= my; b.x += mx; b.y += my;
        }
    }

    update(dt) {
        this.timeLeft -= dt;
        if (this.timeLeft <= 0) return this.gameOver(true);
        if (this.nextStationIndex < this.stations.length) {
            const st = this.stations[this.nextStationIndex];
            if (this.timeLeft <= st.t) { this.triggerStationEvent(st); this.nextStationIndex++; }
        }
        if (this.player.seat) this.energy = Math.min(CONFIG.ENERGY_MAX, this.energy + CONFIG.ENERGY_REGAIN * dt);
        else this.energy = Math.max(0, this.energy - CONFIG.ENERGY_DRAIN * dt);
        if (this.energy <= 0) return this.gameOver(false);

        if (!this.player.seat) {
            let dx = 0, dy = 0;
            if (this.keys['ArrowUp'] || this.keys['w']) dy = -1;
            if (this.keys['ArrowDown'] || this.keys['s']) dy = 1;
            if (this.keys['ArrowLeft'] || this.keys['a']) dx = -1;
            if (this.keys['ArrowRight'] || this.keys['d']) dx = 1;
            if (dx || dy) {
                const l = Math.hypot(dx, dy);
                this.player.x += (dx/l) * CONFIG.PLAYER_SPEED * dt;
                this.player.y += (dy/l) * CONFIG.PLAYER_SPEED * dt;
            } else if (this.pointer.isDown) {
                const pdx = this.pointer.x - this.player.x, pdy = this.pointer.y - this.player.y;
                const d = Math.hypot(pdx, pdy);
                if (d > 5) {
                    this.player.x += (pdx/d) * CONFIG.PLAYER_SPEED * dt;
                    this.player.y += (pdy/d) * CONFIG.PLAYER_SPEED * dt;
                }
            }
            this.player.x = Math.max(20, Math.min(this.width-20, this.player.x));
            this.player.y = Math.max(20, Math.min(this.height-20, this.player.y));
            this.seats.forEach(s => { if(s.isVacant && !s.occupant && checkCircleRect(this.player, s)) this.player.sit(s); });
            this.npcs.forEach(n => { if(!n.seat && !n.isExiting) this.resolveCollision(this.player, n); });
        }

        this.npcs.forEach(n => {
            if (n.isDead || n.seat) return;
            let tx = n.x, ty = n.y, spd = 0;
            if (n.isExiting) {
                tx = n.targetDoor.x; ty = n.targetDoor.y; spd = CONFIG.NPC_EXIT_SPEED;
                if (Math.hypot(tx - n.x, ty - n.y) < 10) { n.isDead = true; return; }
            } else if (n.targetSeat) {
                if (!n.targetSeat.isVacant || n.targetSeat.occupant) { n.targetSeat = null; }
                else {
                    tx = n.targetSeat.x + n.targetSeat.w/2; ty = n.targetSeat.y + n.targetSeat.h/2;
                    spd = this.currentLevel.rushSpeed;
                    if (checkCircleRect(n, n.targetSeat)) { n.sit(n.targetSeat); return; }
                }
            }
            if (spd > 0) {
                const ndx = tx - n.x, ndy = ty - n.y;
                const d = Math.hypot(ndx, ndy);
                n.x += (ndx/d) * spd * dt; n.y += (ndy/d) * spd * dt;
            }
            if (!n.isExiting && !n.targetSeat) {
                this.npcs.forEach(o => { if(n!==o && !o.seat && !o.isExiting) this.resolveCollision(n, o); });
            }
        });
        this.npcs = this.npcs.filter(n => !n.isDead);
        this.updateUI();
    }

    triggerStationEvent(st) {
        const notif = document.getElementById('notification');
        const stName = (CUR_LANG === 'zh') ? st.name_zh : st.name_en;
        notif.innerText = `${TEXT[CUR_LANG].arrival}: ${stName}`;
        notif.style.opacity = 1;
        setTimeout(() => notif.style.opacity = 0, 3000);
        this.doorsOpen = true; setTimeout(() => this.doorsOpen = false, 4000);

        const seated = this.npcs.filter(n => n.seat);
        const count = Math.floor(rnd(3, 7)); 
        seated.sort(() => Math.random() - 0.5);
        seated.slice(0, count).forEach(n => {
            const s = n.seat;
            let dx, dy;
            if(this.isPortrait) {
                dx = (n.x < this.width/2) ? 0 : this.width; dy = this.height/2; 
            } else {
                dx = this.width/2; dy = (n.y < this.height/2) ? 0 : this.height; 
            }
            n.exitTrain(dx, dy);
            s.isVacant = true;
            this.assignRushers(s);
        });
        
        const enter = Math.floor(rnd(2, 5));
        for(let i=0; i<enter; i++) {
            let nx, ny, tx, ty;
            if(this.isPortrait) {
                const isLeft = Math.random()>0.5;
                nx = isLeft ? 10 : this.width-10; ny = this.height/2 + rnd(-20,20);
                tx = isLeft ? 120 : this.width-120; ty = ny;
            } else {
                const isTop = Math.random()>0.5;
                nx = this.width/2 + rnd(-20,20); ny = isTop ? 10 : this.height-10;
                tx = nx; ty = isTop ? 150 : this.height-150;
            }
            const n = new Actor(nx, ny, false);
            n.x = tx; n.y = ty; this.npcs.push(n);
        }
    }

    assignRushers(s) {
        const stand = this.npcs.filter(n => !n.seat && !n.isExiting && !n.targetSeat);
        stand.sort((a,b) => getDist(a, {x:s.x, y:s.y}) - getDist(b, {x:s.x, y:s.y}));
        for(let i=0; i<Math.min(stand.length, 1); i++) stand[i].targetSeat = s;
    }

    draw() {
        this.ctx.clearRect(0,0,this.width, this.height);
        
        // Full background floor
        this.ctx.fillStyle = CONFIG.FLOOR; 
        this.ctx.fillRect(0, 0, this.width, this.height);

        // Doors & Walls
        this.ctx.fillStyle = this.doorsOpen ? CONFIG.COLORS.DOOR_OPEN : CONFIG.COLORS.DOOR;
        if (this.isPortrait) {
            // Draw walls covering sides, leaving center aisle
            // Actually, for portrait, floor is everywhere, just draw doors
            this.ctx.fillRect(0, this.height/2 - 50, 40, 100);
            this.ctx.fillRect(this.width-40, this.height/2 - 50, 40, 100);
        } else {
            // Landscape doors
            this.ctx.fillRect(this.width/2 - 50, 0, 100, 40);
            this.ctx.fillRect(this.width/2 - 50, this.height-40, 100, 40);
        }

        this.seats.forEach(s => s.draw(this.ctx));
        this.npcs.forEach(n => n.draw(this.ctx));
        this.player.draw(this.ctx);
        if (this.pointer.isDown) {
            this.ctx.beginPath(); this.ctx.arc(this.pointer.x, this.pointer.y, 20, 0, Math.PI*2);
            this.ctx.strokeStyle = CONFIG.COLORS.TARGET_RING; this.ctx.lineWidth = 3; this.ctx.stroke();
            if(!this.player.seat) {
                this.ctx.beginPath(); this.ctx.moveTo(this.player.x, this.player.y); this.ctx.lineTo(this.pointer.x, this.pointer.y);
                this.ctx.strokeStyle = "rgba(46,204,113,0.5)"; this.ctx.lineWidth=2; this.ctx.stroke();
            }
        }
    }

    loop(ts) {
        if(!this.isRunning) return;
        let dt = (ts - this.lastTime)/1000; if(dt>0.1) dt=0.1; this.lastTime = ts;
        if(!this.isPaused) { this.update(dt); this.draw(); }
        requestAnimationFrame(t => this.loop(t));
    }

    updateUI() {
        document.getElementById('energyFill').style.width = this.energy + '%';
        document.getElementById('energyFill').style.backgroundColor = this.energy>30?'#2ecc71':'#e74c3c';
        document.getElementById('timer').innerText = Math.ceil(this.timeLeft) + 's';
        const p = ((this.totalDuration - this.timeLeft) / this.totalDuration) * 90 + 5;
        document.getElementById('trainIcon').style.left = p + '%';
    }

    gameOver(win) {
        this.isRunning = false;
        document.getElementById('gameOverScreen').classList.remove('hidden');
        document.getElementById('hud').classList.add('hidden');
        const t = TEXT[CUR_LANG];
        const title = document.getElementById('resultTitle');
        if(win) {
            let s = this.energy>=80?3:(this.energy>=50?2:1);
            title.innerText = t.safe; title.style.color = "#f1c40f";
            document.getElementById('resultStars').innerText = "‚≠ê".repeat(s);
            document.getElementById('resultMessage').innerText = `${t.finalEnergy}: ${Math.floor(this.energy)}`;
        } else {
            title.innerText = t.exhausted; title.style.color = "#e74c3c";
            document.getElementById('resultStars').innerText = "‚ò†Ô∏è";
            document.getElementById('resultMessage').innerText = t.collapsed;
        }
    }
}

const game = new Game();
</script>
</body>
</html>